 
 #define F_CPU 2000000
 #include <avr/interrupt.h>
 #include <util/delay.h>

 #define lcd_data PORTJ_OUT
 #define E_Low() PORTK_OUTCLR=PIN0_bm
 #define E_High() PORTK_OUTSET=PIN0_bm
 #define RS_Low() PORTK_OUTCLR=PIN2_bm
 #define RS_High() PORTK_OUTSET=PIN2_bm
 #define RST_Low() PORTK_OUTCLR=PIN3_bm
 #define RST_High() PORTK_OUTSET=PIN3_bm
 #define CS1_Low() PORTK_OUTSET=PIN4_bm
 #define CS1_High() PORTK_OUTCLR=PIN4_bm
 #define CS2_Low() PORTK_OUTSET=PIN5_bm
 #define CS2_High() PORTK_OUTCLR=PIN5_bm

 void glcd_init(void);
 void lcd_dataout(unsigned char data);
 void lcd_command(unsigned char command);
 void set_page_left(unsigned char page);
 void set_page_right(unsigned char page);
 void set_y_left(unsigned char y);
 void set_y_right(unsigned char y);
 
unsigned char Symb[1000] = {	 
	 // font data
	 0x00, 0x00, 0x00, 0x00, 0x00,// (space)
	 0x00, 0x00, 0x5F, 0x00, 0x00,// !
	 0x00, 0x07, 0x00, 0x07, 0x00,// "
	 0x14, 0x7F, 0x14, 0x7F, 0x14,// #
	 0x24, 0x2A, 0x7F, 0x2A, 0x12,// $
	 0x23, 0x13, 0x08, 0x64, 0x62,// %
	 0x36, 0x49, 0x55, 0x22, 0x50,// &
	 0x00, 0x05, 0x03, 0x00, 0x00,// '
	 0x00, 0x1C, 0x22, 0x41, 0x00,// (
	 0x00, 0x41, 0x22, 0x1C, 0x00,// )
	 0x08, 0x2A, 0x1C, 0x2A, 0x08,// *
	 0x08, 0x08, 0x3E, 0x08, 0x08,// +
	 0x00, 0x50, 0x30, 0x00, 0x00,// ,
	 0x08, 0x08, 0x08, 0x08, 0x08,// -
	 0x00, 0x60, 0x60, 0x00, 0x00,// .
	 0x20, 0x10, 0x08, 0x04, 0x02,// /
	 0x3E, 0x51, 0x49, 0x45, 0x3E,// 0
	 0x00, 0x42, 0x7F, 0x40, 0x00,// 1
	 0x42, 0x61, 0x51, 0x49, 0x46,// 2
	 0x21, 0x41, 0x45, 0x4B, 0x31,// 3
	 0x18, 0x14, 0x12, 0x7F, 0x10,// 4
	 0x27, 0x45, 0x45, 0x45, 0x39,// 5
	 0x3C, 0x4A, 0x49, 0x49, 0x30,// 6
	 0x01, 0x71, 0x09, 0x05, 0x03,// 7
	 0x36, 0x49, 0x49, 0x49, 0x36,// 8
	 0x06, 0x49, 0x49, 0x29, 0x1E,// 9
	 0x00, 0x36, 0x36, 0x00, 0x00,// :
	 0x00, 0x56, 0x36, 0x00, 0x00,// ;
	 0x00, 0x08, 0x14, 0x22, 0x41,// <
	 0x14, 0x14, 0x14, 0x14, 0x14,// =
	 0x41, 0x22, 0x14, 0x08, 0x00,// >
	 0x02, 0x01, 0x51, 0x09, 0x06,// ?
	 0x32, 0x49, 0x79, 0x41, 0x3E,// @
	 0x7E, 0x11, 0x11, 0x11, 0x7E,// A
	 0x7F, 0x49, 0x49, 0x49, 0x36,// B
	 0x3E, 0x41, 0x41, 0x41, 0x22,// C
	 0x7F, 0x41, 0x41, 0x22, 0x1C,// D
	 0x7F, 0x49, 0x49, 0x49, 0x41,// E
	 0x7F, 0x09, 0x09, 0x01, 0x01,// F
	 0x3E, 0x41, 0x41, 0x51, 0x32,// G
	 0x7F, 0x08, 0x08, 0x08, 0x7F,// H
	 0x00, 0x41, 0x7F, 0x41, 0x00,// I
	 0x20, 0x40, 0x41, 0x3F, 0x01,// J
	 0x7F, 0x08, 0x14, 0x22, 0x41,// K
	 0x7F, 0x40, 0x40, 0x40, 0x40,// L
	 0x7F, 0x02, 0x04, 0x02, 0x7F,// M
	 0x7F, 0x04, 0x08, 0x10, 0x7F,// N
	 0x3E, 0x41, 0x41, 0x41, 0x3E,// O
	 0x7F, 0x09, 0x09, 0x09, 0x06,// P
	 0x3E, 0x41, 0x51, 0x21, 0x5E,// Q
	 0x7F, 0x09, 0x19, 0x29, 0x46,// R
	 0x46, 0x49, 0x49, 0x49, 0x31,// S
	 0x01, 0x01, 0x7F, 0x01, 0x01,// T
	 0x3F, 0x40, 0x40, 0x40, 0x3F,// U
	 0x1F, 0x20, 0x40, 0x20, 0x1F,// V
	 0x7F, 0x20, 0x18, 0x20, 0x7F,// W
	 0x63, 0x14, 0x08, 0x14, 0x63,// X
	 0x03, 0x04, 0x78, 0x04, 0x03,// Y
	 0x61, 0x51, 0x49, 0x45, 0x43,// Z
	 0x00, 0x00, 0x7F, 0x41, 0x41,// [
	 0x02, 0x04, 0x08, 0x10, 0x20,// "\"
	 0x41, 0x41, 0x7F, 0x00, 0x00,// ]
	 0x04, 0x02, 0x01, 0x02, 0x04,// ^
	 0x40, 0x40, 0x40, 0x40, 0x40,// _
	 0x00, 0x01, 0x02, 0x04, 0x00,// `
	 0x20, 0x54, 0x54, 0x54, 0x78,// a
	 0x7F, 0x48, 0x44, 0x44, 0x38,// b
	 0x38, 0x44, 0x44, 0x44, 0x20,// c
	 0x38, 0x44, 0x44, 0x48, 0x7F,// d
	 0x38, 0x54, 0x54, 0x54, 0x18,// e
	 0x08, 0x7E, 0x09, 0x01, 0x02,// f
	 0x08, 0x14, 0x54, 0x54, 0x3C,// g
	 0x7F, 0x08, 0x04, 0x04, 0x78,// h
	 0x00, 0x44, 0x7D, 0x40, 0x00,// i
	 0x20, 0x40, 0x44, 0x3D, 0x00,// j
	 0x00, 0x7F, 0x10, 0x28, 0x44,// k
	 0x00, 0x41, 0x7F, 0x40, 0x00,// l
	 0x7C, 0x04, 0x18, 0x04, 0x78,// m
	 0x7C, 0x08, 0x04, 0x04, 0x78,// n
	 0x38, 0x44, 0x44, 0x44, 0x38,// o
	 0x7C, 0x14, 0x14, 0x14, 0x08,// p
	 0x08, 0x14, 0x14, 0x18, 0x7C,// q
	 0x7C, 0x08, 0x04, 0x04, 0x08,// r
	 0x48, 0x54, 0x54, 0x54, 0x20,// s
	 0x04, 0x3F, 0x44, 0x40, 0x20,// t
	 0x3C, 0x40, 0x40, 0x20, 0x7C,// u
	 0x1C, 0x20, 0x40, 0x20, 0x1C,// v
	 0x3C, 0x40, 0x30, 0x40, 0x3C,// w
	 0x44, 0x28, 0x10, 0x28, 0x44,// x
	 0x0C, 0x50, 0x50, 0x50, 0x3C,// y
	 0x44, 0x64, 0x54, 0x4C, 0x44,// z
	 0x00, 0x08, 0x36, 0x41, 0x00,// {
	 0x00, 0x00, 0x7F, 0x00, 0x00,// |
	 0x00, 0x41, 0x36, 0x08, 0x00,// }
	 0x08, 0x08, 0x2A, 0x1C, 0x08,// ->
	 0x08, 0x1C, 0x2A, 0x08, 0x08,// <-
	 0x7C, 0x14, 0x14, 0x14, 0x08,//p
	 0x38, 0x44, 0x44, 0x44, 0x20,//c
	 0x04, 0x04, 0x7c, 0x04, 0x04,//т
	 0x0C, 0x50, 0x50, 0x50, 0x3C,//у
	 0x30, 0x48, 0xfc, 0x48, 0x30,//ф
	 0x44, 0x28, 0x10, 0x28, 0x44,//x
	 0x7c, 0x40, 0x40, 0x40, 0xfc,//ц
	 0x0c, 0x10, 0x10, 0x10, 0x7c,//ч
	 0x7c, 0x40, 0x7c, 0x40, 0x7c,//ш
	 0x7c, 0x40, 0x7c, 0x40, 0xfc,//щ
	 0x04, 0x7c, 0x50, 0x50, 0x20,//ъ
	 0x7c, 0x50, 0x50, 0x20, 0x7c,//ы
	 0x7c, 0x50, 0x50, 0x20, 0x00,//ь
	 0x28, 0x44, 0x54, 0x54, 0x38,//э
	 0x7c, 0x10, 0x38, 0x44, 0x38,//ю
	 0x08, 0x54, 0x34, 0x14, 0x7c,//я
	 0x7e, 0x11, 0x11, 0x11, 0x7e,//A
	 0x7f, 0x49, 0x49, 0x49, 0x33,//Б
	 0x7f, 0x49, 0x49, 0x49, 0x36,//В
	 0x7f, 0x01, 0x01, 0x01, 0x03,//Г
	 0xe0, 0x51, 0x4f, 0x41, 0xff,//Д
	 0x7f, 0x49, 0x49, 0x49, 0x41,//E
	 0x77, 0x08, 0x7f, 0x08, 0x77,//Ж
	 0x41, 0x49, 0x49, 0x49, 0x36,//З
	 0x7f, 0x10, 0x08, 0x04, 0x7f,//И
	 0x7c, 0x21, 0x12, 0x09, 0x7c,//Й
	 0x7f, 0x08, 0x14, 0x22, 0x41,//K
	 0x20, 0x41, 0x3f, 0x01, 0x7f,//Л
	 0x7f, 0x02, 0x0c, 0x02, 0x7f,//M
	 0x7f, 0x08, 0x08, 0x08, 0x7f,//H
	 0x3e, 0x41, 0x41, 0x41, 0x3e,//O
	 0x7f, 0x01, 0x01, 0x01, 0x7f,//П
	 0x7f, 0x09, 0x09, 0x09, 0x06,//P
	 0x3e, 0x41, 0x41, 0x41, 0x22,//C
	 0x01, 0x01, 0x7f, 0x01, 0x01,//T
	 0x47, 0x28, 0x10, 0x08, 0x07,//У
	 0x1c, 0x22, 0x7f, 0x22, 0x1c,//Ф
	 0x63, 0x14, 0x08, 0x14, 0x63,//X
	 0x7f, 0x40, 0x40, 0x40, 0xff,//Ц
	 0x07, 0x08, 0x08, 0x08, 0x7f,//Ч
	 0x7f, 0x40, 0x7f, 0x40, 0x7f,//Ш
	 0x7f, 0x40, 0x7f, 0x40, 0xff,//Щ
	 0x01, 0x7f, 0x48, 0x48, 0x30,//Ъ
	 0x7f, 0x48, 0x30, 0x00, 0x7f,//Ы
	 0x00, 0x7f, 0x48, 0x48, 0x30,//Э
	 0x22, 0x41, 0x49, 0x49, 0x3e,//Ь
	 0x7f, 0x08, 0x3e, 0x41, 0x3e,//Ю
	 0x46, 0x29, 0x19, 0x09, 0x7f,//Я
	 0x20, 0x54, 0x54, 0x54, 0x78,//a
	 0x3c, 0x4a, 0x4a, 0x49, 0x31,//б
	 0x7c, 0x54, 0x54, 0x28, 0x00,//в
	 0x7c, 0x04, 0x04, 0x04, 0x0c,//г
	 0xe0, 0x54, 0x4c, 0x44, 0xfc,//д
	 0x38, 0x54, 0x54, 0x54, 0x18,//e
	 0x6c, 0x10, 0x7c, 0x10, 0x6c,//ж
	 0x44, 0x44, 0x54, 0x54, 0x28,//з
	 0x7c, 0x20, 0x10, 0x08, 0x7c,//и
	 0x7c, 0x41, 0x22, 0x11, 0x7c,//й
	 0x7c, 0x10, 0x28, 0x44, 0x00,//к
	 0x20, 0x44, 0x3c, 0x04, 0x7c,//л
	 0x7c, 0x08, 0x10, 0x08, 0x7c,//м
	 0x7c, 0x10, 0x10, 0x10, 0x7c,//н
	 0x38, 0x44, 0x44, 0x44, 0x38,//o
	 0x7c, 0x04, 0x04, 0x04, 0x7c,//п
 };

 unsigned char xmega[512]={
	 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x30,0xF0,0xF0,0xF0,0xE0,0x80,0x00,0x00,0x00,0x00,
	 0x00,0x00,0x00,0x80,0xE0,0xF0,0xF0,0xF0,0x30,0x00,0x00,0x00,0x00,0xF0,0xF0,0xF0,
	 0xF0,0xF0,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xF0,0xF0,
	 0xF0,0xF0,0xF0,0x00,0x00,0x00,0x00,0x00,0xF0,0xF0,0xF0,0xF0,0x70,0x70,0x70,0x70,
	 0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x00,0x00,0x00,0x00,0x00,0x00,
	 0x80,0xC0,0xE0,0xE0,0xE0,0xF0,0x70,0x70,0x70,0x70,0x70,0xF0,0xE0,0xE0,0xE0,0xC0,
	 0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF0,0xF0,
	 0xF0,0xF0,0xF0,0xF0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,
	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x0F,0x1F,0x3F,0xFE,0xF8,0xF0,
	 0xF8,0xFE,0x3F,0x1F,0x0F,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,
	 0xFF,0x7F,0xFF,0xFF,0xF8,0xC0,0x00,0x00,0x00,0x00,0xC0,0xF8,0xFF,0xFF,0x7F,0xFF,
	 0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xE0,0xE0,0xE0,0xE0,
	 0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0x00,0x00,0x00,0x00,0x00,0xF0,0xFE,0xFF,
	 0xFF,0x0F,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x81,0x83,0x8F,
	 0x8F,0x8F,0x8E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF0,0xFE,0xFF,0x7F,0x1F,
	 0x03,0x03,0x1F,0x7F,0xFF,0xFE,0xF0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xE0,0xF0,0xF8,0xFE,0x3F,0x1F,0x0F,0x03,
	 0x0F,0x1F,0x3F,0xFE,0xF8,0xF0,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,
	 0xFF,0x00,0x03,0x1F,0xFF,0xFF,0xFE,0xF0,0xF0,0xFE,0xFF,0xFF,0x1F,0x03,0x00,0xFF,
	 0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,
	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x3F,0x7F,
	 0xFF,0xF8,0xE0,0xC0,0x80,0x80,0x00,0x00,0x00,0x03,0x03,0x83,0x83,0xC3,0xF3,0xFF,
	 0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0xC0,0xF0,0xFE,0xFF,0x7F,0x3F,0x3B,0x38,0x38,
	 0x38,0x38,0x38,0x38,0x3B,0x3F,0x7F,0xFF,0xFE,0xF0,0xC0,0x00,0x00,0x00,0x00,0x00,
	 0x00,0x00,0x00,0x00,0x00,0x06,0x07,0x07,0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00,
	 0x00,0x00,0x00,0x00,0x01,0x03,0x07,0x07,0x07,0x06,0x00,0x00,0x00,0x07,0x07,0x07,
	 0x07,0x00,0x00,0x00,0x00,0x07,0x07,0x07,0x07,0x07,0x07,0x00,0x00,0x00,0x00,0x07,
	 0x07,0x07,0x07,0x00,0x00,0x00,0x00,0x00,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,
	 0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x00,0x00,0x00,0x00,0x00,0x00,
	 0x00,0x01,0x03,0x03,0x03,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x03,0x03,0x01,0x07,
	 0x07,0x07,0x07,0x00,0x00,0x00,0x06,0x07,0x07,0x07,0x03,0x00,0x00,0x00,0x00,0x00,
	 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x07,0x07,0x06,0x00,0x00,0x00,0x00,
 };
 
 /*void printc(char c, int strNum, int charNum){
	 set_page_left(strNum);
	 set_y_left(charNum*5);
	 for(int i=0;i<5;i++)
		lcd_dataout(Symb[((int)c-32)*5+i]);	 
 }*/
 
 void println(char* s,int strNum){
	set_page_left(strNum);
	set_y_left(0);
	int i=0;
	while(*s){
		//отпечатали символ
		char c = *s++;
		for(int j=0;j<5;j++){
			i++;
			if(i==65){
				set_page_right(strNum);
				set_y_right(0);
			}
			if(i>127)break;
			lcd_dataout(Symb[((int)c-32)*5+j]);
		}
	}
 }


 int main(void)
 {
	 unsigned int i;

	 PORTJ_DIR=PIN7_bm|PIN6_bm|PIN5_bm|PIN4_bm|PIN3_bm|PIN2_bm|PIN1_bm|PIN0_bm;
	 PORTK_DIR=PIN5_bm|PIN4_bm|PIN3_bm|PIN2_bm|PIN1_bm|PIN0_bm;
	 glcd_init();
	 
	 glcd_clear();
	 _delay_ms(500);
	 
	 set_page_left(0);
	 set_page_right(0);
	 set_y_left(0);
	 set_y_right(0);
	 for(int i=0;i<5*5;i++)
	 {
		 if((i%64)==0)
		 {
			 if((i%128)==0)
			 {
				 set_page_left(i/128);
				 set_y_left(0);
			 }
			 else
			 {
				 set_page_right(i/128);
				 set_y_right(0);
			 }
		 }
		 lcd_dataout(Symb[i]);
		 
	 }
	 
	 println("A B C D E F G H I G K L M N O",1);
	
	 
	 
	 while(1);
 }
 
 void glcd_clear(){
	set_page_left(0);
	set_page_right(0);
	set_y_left(0);
	set_y_right(0);
	for(int i=0;i<1024;i++)
	{
		if((i%64)==0)
		{
			if((i%128)==0)
			{
				set_page_left(i/128);
				set_y_left(0);
			}
			else
			{
				set_page_right(i/128);
				set_y_right(0);
			}
		}
		lcd_dataout(0x00);
	
	}
	_delay_ms(500); 
 }

 //---------------------------------------------------

 void glcd_init(void)
 {
	 //перезагружаем контроллер
	 //ждем, пока питание будет стабильным
	 RST_Low();
	 _delay_ms(10);
	 RST_High();
	 _delay_ms(100);
	 
	 //отключаем оба контроллера
	 CS1_High();
	 CS2_High();
	 //отключаем дисплей
	 lcd_command(0x3e);    // display off
	 //устанавливаем номер колонки равным 0
	 lcd_command(0x40);
	 //устанавливаем номер страницы равным 0
	 lcd_command(0xb8);
	 //номер линии, начиная с которой данные будут отображаться на дисплее (если 0, то с самого начала, если 10, то
	 //изображение будет смещено на 10 линий вверх, а его невлезшая часть отобразится снизу)
	 lcd_command(0xc0);
	 //включаем дисплей
	 lcd_command(0x3f);
 }

 //---------------------------------------------------
 //отослать LCD-дисплею инструкцию
 void lcd_command(unsigned char command)
 {
	 //сигнал о том, что будем передавать инструкцию
	 RS_Low();
	 //отправляем инструкцию
	 lcd_data=command;
	 //стробирование
	 E_High();
	 _delay_us(10);
	 E_Low();
	 _delay_us(10);
 }

 //---------------------------------------------------
 //отослать LCD-дисплею данные
 void lcd_dataout(unsigned char data)
 {
	 //сигнал о том, что будем передавать данные
	 RS_High();
	 //отправляем данные
	 lcd_data=data;
	 //стробирование
	 E_High();
	 _delay_us(10);
	 E_Low();
	 _delay_us(10);
 }

 //---------------------------------------------------
 //выбираем страницу в левой части дисплея
 void set_page_left(unsigned char page)
 {
	 CS1_High();
	 CS2_Low();
	 lcd_command(0xb8 + page);
 }

 //---------------------------------------------------
 //выбираем страницу в правой части дисплея
 void set_page_right(unsigned char page)
 {
	 CS1_Low();
	 CS2_High();
	 lcd_command(0xb8 + page);
 }

 //---------------------------------------------------
 //выбираем номер колонки в левой части дисплея
 void set_y_left(unsigned char y)
 {
	 CS1_High();
	 CS2_Low();
	 lcd_command(0x40 + y);
 }

 //---------------------------------------------------
 //выбираем номер колонки в правой части дисплея
 void set_y_right(unsigned char y)
 {
	 CS1_Low();
	 CS2_High();
	 lcd_command(0x40 + y);
 }
